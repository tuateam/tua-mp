!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.TuaMp={})}(this,function(t){"use strict";var e=/^__.*__$/,b=[String,Number,Boolean,Object,Array,null],l={enumerable:!0,configurable:!0},c=Object.prototype.toString,d="__TUA_PATH",y="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},r=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},n=function(){function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t}}(),h=function(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t},m=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},O=function(t,e){var r={};for(var n in t)0<=e.indexOf(n)||Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n]);return r},j=function(t){return console.warn("[TUA-MP warn]: "+t)},g=function(t){return"function"==typeof t},v=function(t){return!e.test(t)},w=function(t,e){return""===t?e:t+"."+e},A=function(e,r){Object.keys(e).forEach(function(t){Object.defineProperty(r,t,Object.getOwnPropertyDescriptor(e,t))})},f=function(t,e){var r,n,o,a=void 0,i=(n=(r=e)&&r.toString().match(/^\s*function (\w+)/))?n[1]:"";if(/(String|Number|Boolean)/.test(i)){var u=void 0===t?"undefined":y(t);(a=u===i.toLowerCase())||"object"!==u||(a=t instanceof e)}else"Object"===i?(o=t,a="[object Object]"===c.call(o)):a="Array"===i?Array.isArray(t):t instanceof e;return{valid:a,expectedType:i}},P=function(t){var e=t.prop,r=t.name,o=t.value;if(null==o)return!0;var n,a=[],i=e.type,u=!i;i&&(Array.isArray(i)?i:[i]).forEach(function(t){var e=f(o,t),r=e.valid,n=e.expectedType;a.push(n),u=r});return u||j('Invalid prop: type check failed for prop "'+r+'". Expected '+a.join(", ")+", got "+(n=o,c.call(n).slice(8,-1))+"."),u},_=Array.prototype,S=["pop","push","sort","shift","splice","unshift","reverse"],p=function(){function t(){r(this,t),this.subs=[]}return n(t,[{key:"addSub",value:function(t){-1<this.subs.indexOf(t)||this.subs.push(t)}},{key:"notify",value:function(){this.subs.slice().forEach(function(t){return t()})}}]),t}(),i=p.targetCb=null,u=null,k=null,C=function(o,a){return function(t){var e=t.path,r=t.newVal,n=t.oldVal;i=m({},i,h({},e,r)),u=m(h({},e,n),u),Promise.resolve().then(function(){i&&(o.setData(i),Object.keys(i).filter(function(t){return g(a[t])}).forEach(function(t){var e=a[t],r=i[t],n=u[t];e.call(o,r,n)}),u=i=null)})}},D=function(t){var o=t.obj,a=t.key,i=t.val,u=t.observeDeep,c=t.asyncSetData,f=new p;Object.defineProperty(o,a,m({},l,{get:function(){return p.targetCb&&f.addSub(p.targetCb),i},set:function(t){if(t!==i){var e=i,r=o[d]||"",n=w(r,a);i=u(t,n),c({path:n,newVal:t,oldVal:e}),f.notify()}}}))},x=function(s){return function r(e){var t,n,o,a,c,f,l,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";if(Array.isArray(e)){var u=e.map(function(t,e){return r(t,i+"["+e+"]")});return u[d]=i,k=k||(c=(a={observeDeep:r,asyncSetData:s}).observeDeep,f=a.asyncSetData,l=Object.create(_),S.forEach(function(i){var u=_[i];l[i]=function(){for(var t=this[d],e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];var o=u.apply(this,r);if("pop"===i)f({path:t,newVal:this});else{var a=c(this,t);Object.assign(this,a),f({path:t,newVal:a})}return o}}),l),n=(t={arr:u,arrayMethods:k}).arr,o=t.arrayMethods,Object.setPrototypeOf?Object.setPrototypeOf(n,o):"__proto__"in n?n.__proto__=o:A(o,n),n}if("object"===(void 0===e?"undefined":y(e))){var p=Object.create(null);return Object.defineProperty(p,d,{enumerable:!1,value:i}),Object.keys(e).filter(v).map(function(t){return{obj:p,key:t,val:r(e[t],w(i,t)),observeDeep:r,asyncSetData:s}}).forEach(D),p}return e}},E=function(t,e){var r=e(t.data);t.$data=r,A(r,t)},T=function(a,i,u){var c=Object.create(null);Object.keys(i).forEach(function(t){var e=new p,r=i[t].bind(a),n=r(),o=!0;Object.defineProperty(c,t,m({},l,{get:function(){return p.targetCb&&e.addSub(p.targetCb),o?(p.targetCb=function(){u({path:t,newVal:r(),oldVal:n}),e.notify()},n=r(),p.targetCb=null,o=!1,n):n=r()},set:function(){j("请勿对 computed 属性 "+t+" 赋值，它应该由 data 中的依赖自动计算得到！")}}))}),a.$computed=c,A(c,a),a.setData(c)};t.TuaComp=function(t){var a,e=t.data,r=void 0===e?{}:e,n=t.props,o=void 0===n?{}:n,i=t.watch,u=void 0===i?{}:i,c=t.methods,f=void 0===c?{}:c,l=t.computed,p=void 0===l?{}:l,s=t.properties,d=void 0===s?{}:s,y=O(t,["data","props","watch","methods","computed","properties"]),v=g(r)?r():r;return Component(m({},y,{data:v,methods:f,properties:m({},d,(a=o,Array.isArray(a)?a.map(function(t){return h({},t,null)}).reduce(function(t,e){return m({},t,e)},{}):Object.keys(a).map(function(o){var t=a[o];if(-1!==b.indexOf(t))return h({},o,t);var e=function(n){return function(t){var e=P({prop:n,name:o,value:t}),r=n.validator;return r&&!r(t)?(j('Invalid prop: custom validator check failed for prop "'+o+'".'),!1):e}};if(Array.isArray(t)){var r={type:null,observer:e({type:t})};return h({},o,r)}var n={type:t.type||null,value:g(t.default)?t.default():t.default,observer:e(t)};return h({},o,n)}).reduce(function(t,e){return m({},t,e)},{}))),attached:function(){var t=C(this,u),e=x(t);E(this,e),T(this,p,t);for(var r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];y.attached&&y.attached.apply(this,n)}}))},t.TuaPage=function(t){var e=t.data,r=void 0===e?{}:e,n=t.watch,a=void 0===n?{}:n,o=t.methods,i=void 0===o?{}:o,u=t.computed,c=void 0===u?{}:u,f=O(t,["data","watch","methods","computed"]),l=g(r)?r():r;return Page(m({},f,i,{data:l,onLoad:function(){var t=C(this,a),e=x(t);E(this,e),T(this,c,t);for(var r=arguments.length,n=Array(r),o=0;o<r;o++)n[o]=arguments[o];f.onLoad&&f.onLoad.apply(this,n)}}))},Object.defineProperty(t,"__esModule",{value:!0})});
